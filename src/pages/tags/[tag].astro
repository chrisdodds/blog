---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";

export async function getStaticPaths() {
  const allPosts = await getCollection("blog");
  const tags = [...new Set(allPosts.flatMap((post) => post.data.tags || []))];

  return tags.map((tag) => ({
    params: { tag },
    props: {
      posts: allPosts
        .filter((post) => post.data.tags?.includes(tag))
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
    },
  }));
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<Layout title={`Posts tagged "${tag}" - Chris Dodds`}>
  <main id="main-content">
    <Header />

    <section class="tag-posts">
      <div class="tag-header">
        <a href="/tags/" class="back">‚Üê All tags</a>
        <h1>Posts tagged "{tag}"</h1>
        <p class="count">{posts.length} {posts.length === 1 ? "post" : "posts"}</p>
      </div>

      <div class="posts">
        {
          posts.map((post) => (
            <article class="post-preview">
              <a href={`/blog/${post.slug}/`}>
                <h2>{post.data.title}</h2>
                <time datetime={post.data.pubDate.toISOString()}>
                  {post.data.pubDate.toLocaleDateString("en-us", {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                  })}
                </time>
                <p>{post.data.description}</p>
              </a>
            </article>
          ))
        }
      </div>
    </section>
  </main>
</Layout>

<style>
  .tag-header {
    margin-bottom: 2rem;
  }

  h1 {
    margin-bottom: 0.5rem;
  }

  .count {
    font-size: 0.875rem;
    color: #555;
    margin: 0;
  }
</style>
