---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";

export async function getStaticPaths() {
  const allPosts = await getCollection("blog");
  const tags = [...new Set(allPosts.flatMap((post) => post.data.tags || []))];

  return tags.map((tag) => ({
    params: { tag },
    props: {
      posts: allPosts
        .filter((post) => post.data.tags?.includes(tag))
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
    },
  }));
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<Layout title={`Posts tagged "${tag}" - Chris Dodds`}>
  <main>
    <Header />

    <section class="tag-posts">
      <div class="tag-header">
        <a href="/tags/" class="back">‚Üê All tags</a>
        <h1>Posts tagged "{tag}"</h1>
        <p class="count">{posts.length} {posts.length === 1 ? "post" : "posts"}</p>
      </div>

      <div class="posts">
        {
          posts.map((post) => (
            <article class="post-preview">
              <a href={`/blog/${post.slug}/`}>
                <h2>{post.data.title}</h2>
                <time datetime={post.data.pubDate.toISOString()}>
                  {post.data.pubDate.toLocaleDateString("en-us", {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                  })}
                </time>
                <p>{post.data.description}</p>
              </a>
            </article>
          ))
        }
      </div>
    </section>
  </main>
</Layout>

<style>
  .tag-posts {
    width: 100%;
  }

  .tag-header {
    margin-bottom: 3rem;
  }

  .back {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    color: #6366f1;
    text-decoration: none;
    margin-bottom: 1.5rem;
    font-size: 0.9375rem;
    font-weight: 500;
    transition: all 0.2s ease;
    padding: 0.5rem 0;
  }

  .back:hover {
    color: #4f46e5;
    transform: translateX(-4px);
  }

  h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    color: #1a1a1a;
    letter-spacing: -0.02em;
  }

  .count {
    font-size: 1rem;
    color: #737373;
    margin: 0;
  }

  .posts {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  .post-preview {
    background: #f9faf9;
    border: 1px solid #d4d4d4;
    border-radius: 8px;
    padding: 2rem;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  }

  .post-preview a {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  .post-preview h2 {
    font-size: 1.875rem;
    font-weight: 700;
    margin: 0 0 0.75rem 0;
    color: #1a1a1a;
    letter-spacing: -0.02em;
    line-height: 1.25;
    transition: color 0.2s ease;
  }

  .post-preview a:hover h2 {
    color: #6366f1;
  }

  .post-preview time {
    font-size: 0.875rem;
    color: #a3a3a3;
    display: block;
    margin-bottom: 0.75rem;
  }

  .post-preview p {
    font-size: 1.125rem;
    line-height: 1.7;
    color: #525252;
    margin: 0;
  }

  @media (max-width: 640px) {
    h1 {
      font-size: 2rem;
    }

    .posts {
      gap: 2rem;
    }

    .post-preview h2 {
      font-size: 1.5rem;
    }

    .post-preview p {
      font-size: 1rem;
    }
  }
</style>
